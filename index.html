<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìö Nghe Truy·ªán Online</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    header {
      background: #0077cc;
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    main {
      padding: 1rem;
    }
    #stories {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .story-card {
      background: white;
      border: 1px solid #ccc;
      padding: 1rem;
      width: 200px;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .story-card img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 5px;
    }
    #story-player {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #admin-panel {
      background: #fff4dd;
      padding: 1rem;
      border: 1px solid #ccc;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìö Nghe Truy·ªán Online</h1>
    <div id="user-auth">
      <span id="user-email" style="margin-right: 10px;"></span>
      <button id="googleSignIn">üîê ƒêƒÉng nh·∫≠p Google</button>
      <button onclick="logout()" style="display:none;">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <main>
    <section id="story-list">
      <h2>üìñ Danh s√°ch truy·ªán</h2>
      <div id="stories"></div>
    </section>

    <section id="story-player" style="display: none;">
      <h2 id="story-title">T√™n truy·ªán</h2>
      <img id="story-cover" src="" alt="·∫¢nh truy·ªán" width="200"/>
      <audio id="story-audio" controls style="width:100%; margin-top:10px;"></audio>
      <br/><br/>
      <button onclick="hidePlayer()">‚¨ÖÔ∏è Quay l·∫°i</button>
    </section>

    <!-- ‚úÖ ADMIN PANEL -->
    <section id="admin-panel" style="display: none;">
      <h2>üõ† Qu·∫£n l√Ω truy·ªán (Admin)</h2>
      <form id="story-form">
        <input type="text" id="story-title" placeholder="T√™n truy·ªán" required /><br/><br/>
        <input type="file" id="story-cover-file" accept="image/*" required /><br/><br/>
        <input type="file" id="story-audio-file" accept="audio/*" required /><br/><br/>
        <button type="submit">üì§ Th√™m truy·ªán</button>
      </form>
      <div id="admin-stories"></div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHg0qKWXwuZPNClwTv_VYDvfaQiLAYbJk",
      authDomain: "rinaudio-app.firebaseapp.com",
      projectId: "rinaudio-app",
      storageBucket: "rinaudio-app.appspot.com",
      messagingSenderId: "56465837529",
      appId: "1:56465837529:web:4da849806360e95cd01dc8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // ƒêƒÉng nh·∫≠p Google
    document.getElementById("googleSignIn").addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        alert("‚ùå L·ªói ƒëƒÉng nh·∫≠p Google: " + error.message);
      }
    });

    window.logout = async () => {
      await signOut(auth);
    };

    const ADMIN_EMAIL = "sumi22122005@gmail.com";

    onAuthStateChanged(auth, (user) => {
      const emailSpan = document.getElementById("user-email");
      const btnGoogle = document.getElementById("googleSignIn");
      const btnLogout = document.querySelector("button[onclick='logout()']");
      const adminPanel = document.getElementById("admin-panel");

      if (user) {
        emailSpan.textContent = "üë§ " + user.email;
        btnGoogle.style.display = "none";
        btnLogout.style.display = "inline-block";

        if (user.email === ADMIN_EMAIL) {
          adminPanel.style.display = "block";
          loadAdminStories();
        } else {
          adminPanel.style.display = "none";
        }
      } else {
        emailSpan.textContent = "";
        btnGoogle.style.display = "inline-block";
        btnLogout.style.display = "none";
        adminPanel.style.display = "none";
      }

      loadStories();
    });

    async function loadStories() {
      const storyContainer = document.getElementById("stories");
      storyContainer.innerHTML = "";

      const snap = await getDocs(collection(db, "stories"));
      if (snap.empty) {
        storyContainer.innerHTML = "<p>Kh√¥ng c√≥ truy·ªán n√†o.</p>";
        return;
      }

      snap.forEach((doc) => {
        const s = doc.data();
        const div = document.createElement("div");
        div.className = "story-card";
        div.innerHTML = `<strong>${s.title}</strong><br/><img src="${s.cover}" alt="cover"/>`;
        div.onclick = () => showStory(s);
        storyContainer.appendChild(div);
      });
    }

    function showStory(s) {
      document.getElementById("story-title").innerText = s.title;
      document.getElementById("story-cover").src = s.cover;
      document.getElementById("story-audio").src = s.audio;
      document.getElementById("story-player").style.display = "block";
      document.getElementById("story-list").style.display = "none";
    }

    window.hidePlayer = () => {
      document.getElementById("story-player").style.display = "none";
      document.getElementById("story-list").style.display = "block";
    };

    // TH√äM TRUY·ªÜN M·ªöI
    document.getElementById("story-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("story-title").value;
      const coverFile = document.getElementById("story-cover-file").files[0];
      const audioFile = document.getElementById("story-audio-file").files[0];

      try {
        const coverRef = ref(storage, "covers/" + coverFile.name);
        await uploadBytes(coverRef, coverFile);
        const coverURL = await getDownloadURL(coverRef);

        const audioRef = ref(storage, "audios/" + audioFile.name);
        await uploadBytes(audioRef, audioFile);
        const audioURL = await getDownloadURL(audioRef);

        await addDoc(collection(db, "stories"), {
          title,
          cover: coverURL,
          audio: audioURL
        });

        alert("‚úÖ Truy·ªán ƒë√£ ƒë∆∞·ª£c th√™m!");
        document.getElementById("story-form").reset();
        loadStories();
        loadAdminStories();
      } catch (err) {
        alert("‚ùå L·ªói th√™m truy·ªán: " + err.message);
      }
    });

    // HI·ªÇN TH·ªä DANH S√ÅCH ADMIN
    async function loadAdminStories() {
      const adminContainer = document.getElementById("admin-stories");
      adminContainer.innerHTML = "";

      const snap = await getDocs(collection(db, "stories"));
      snap.forEach((docSnap) => {
        const s = docSnap.data();
        const id = docSnap.id;

        const div = document.createElement("div");
        div.innerHTML = `
          <p><strong>${s.title}</strong></p>
          <button onclick="deleteStory('${id}')">üóë Xo√°</button>
          <hr/>
        `;
        adminContainer.appendChild(div);
      });
    }

    window.deleteStory = async (id) => {
      if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° truy·ªán n√†y?")) {
        await deleteDoc(doc(db, "stories", id));
        alert("‚úÖ ƒê√£ xo√° truy·ªán");
        loadStories();
        loadAdminStories();
      }
    };
  </script>

<style>
#story-actions {
  margin-top: 20px;
}
#comment-list {
  background: #f9f9f9;
  padding: 0.5rem;
  border: 1px solid #ccc;
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 10px;
}
</style>

<script type="module">
import { query, where, getDocs, setDoc, doc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentStoryId = null;

async function showStory(s) {
  document.getElementById("story-title").innerText = s.title;
  document.getElementById("story-cover").src = s.cover;
  document.getElementById("story-audio").src = s.audio;
  document.getElementById("story-player").style.display = "block";
  document.getElementById("story-list").style.display = "none";
  currentStoryId = s.id || s.storyId || s.title; // fallback n·∫øu kh√¥ng c√≥ id r√µ
  loadLikes(currentStoryId);
  loadComments(currentStoryId);
}

// Giao di·ªán n√∫t like + comment
const actionsHTML = \`
<div id="story-actions">
  <button id="like-btn">‚ù§Ô∏è Th√≠ch (<span id="like-count">0</span>)</button>
  <h3>B√¨nh lu·∫≠n</h3>
  <div id="comment-list"></div>
  <textarea id="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."></textarea><br/>
  <button onclick="submitComment()">üí¨ G·ª≠i b√¨nh lu·∫≠n</button>
</div>\`;

document.getElementById("story-player").insertAdjacentHTML("beforeend", actionsHTML);

// Load l∆∞·ª£t like
async function loadLikes(storyId) {
  const likeSnap = await getDocs(collection(db, "stories", storyId, "likes"));
  document.getElementById("like-count").innerText = likeSnap.size;
  const user = auth.currentUser;
  const liked = likeSnap.docs.some(doc => doc.id === user?.email);
  document.getElementById("like-btn").disabled = liked;
}

// B·∫•m like
document.getElementById("like-btn").onclick = async () => {
  const user = auth.currentUser;
  if (!user) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ like!");
  const storyId = currentStoryId;
  const likeRef = doc(db, "stories", storyId, "likes", user.email);
  await setDoc(likeRef, { likedAt: serverTimestamp() });
  loadLikes(storyId);
};

// G·ª≠i b√¨nh lu·∫≠n
window.submitComment = async () => {
  const user = auth.currentUser;
  const text = document.getElementById("comment-input").value.trim();
  if (!user || !text) return;
  await addDoc(collection(db, "stories", currentStoryId, "comments"), {
    text,
    email: user.email,
    createdAt: serverTimestamp()
  });
  document.getElementById("comment-input").value = "";
  loadComments(currentStoryId);
};

// Hi·ªÉn th·ªã b√¨nh lu·∫≠n
async function loadComments(storyId) {
  const commentList = document.getElementById("comment-list");
  commentList.innerHTML = "ƒêang t·∫£i...";
  const snap = await getDocs(collection(db, "stories", storyId, "comments"));
  const comments = snap.docs.map(doc => doc.data());
  commentList.innerHTML = comments.map(c =>
    \`<p><strong>\${c.email}:</strong> \${c.text}</p>\`
  ).join("") || "<p>Ch∆∞a c√≥ b√¨nh lu·∫≠n.</p>";
}
</script>

</body>
</html>
