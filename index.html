<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audio Truyện Online</title>
  <style>
    :root {
      --main-color: #f76da4;
      --light-color: #fdd2e0;
      --bg-color: #fff5f9;
      --text-color: #333;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    header {
      background-color: var(--main-color);
      padding: 1rem;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .menu-toggle {
      font-size: 1.8rem;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
      margin-right: 1rem;
    }
    .nav-menu {
      display: none;
      flex-direction: column;
      background-color: var(--light-color);
      position: absolute;
      top: 100%;
      right: 0;
      width: 200px;
      padding: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 99;
      border-radius: 0 0 0 10px;
      pointer-events: auto;
    }
    .nav-menu.show {
      display: flex;
    }
    main {
      padding: 1rem;
    }
    .story {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: white;
    }
    .story img {
      max-width: 100%;
      border-radius: 10px;
    }
    .admin-panel {
      background-color: #ffeef2;
      padding: 1rem;
      border-radius: 10px;
      margin-top: 2rem;
    }
    .hidden {
      display: none;
    }
    .center {
      text-align: center;
    }
    button {
      background-color: var(--main-color);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      margin-top: 0.5rem;
      border-radius: 5px;
      cursor: pointer;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .user-info img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <header>
    <h1>📚 Audio Truyện</h1>
    <div class="user-info" id="user-info"></div>
    <button class="menu-toggle" onclick="toggleMenu()">☰</button>
    <div class="nav-menu" id="menu">
      <button onclick="showSection('home')">🏠 Trang chủ</button>
      <button id="upload-btn" onclick="showSection('upload')" class="hidden">➕ Thêm truyện</button>
      <div id="auth-section">
        <button onclick="loginWithGoogle()">🔓 Đăng nhập Google</button>
      </div>
    </div>
  </header>

  <main>
    <section id="home-section">
      <h2 class="center">🎧 Danh sách truyện</h2>
      <div id="story-list"></div>
    </section>

    <section id="upload-section" class="hidden">
      <h2>Thêm truyện mới (Admin)</h2>
      <div class="admin-panel">
        <input type="text" id="story-title" placeholder="Tên truyện">
        <textarea id="story-desc" placeholder="Mô tả"></textarea>
        <input type="file" id="story-img" accept="image/*">
        <input type="file" id="story-audio" accept="audio/*">
        <button onclick="uploadStory()">📤 Tải lên</button>
      </div>
    </section>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  signInWithPopup,
  onAuthStateChanged,
  signOut,
  GoogleAuthProvider
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getStorage,
  ref as sRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import {
  getDatabase,
  ref,
  push,
  onValue
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-f5Kz6nsVB8ASYUXAlNUeh0c-eP0lP6s",
  authDomain: "nghe-truyen-6dac9.firebaseapp.com",
  projectId: "nghe-truyen-6dac9",
  storageBucket: "nghe-truyen-6dac9.appspot.com",
  messagingSenderId: "798859322959",
  appId: "1:798859322959:web:a52112ab9d27c0cc1602c3a",
  databaseURL: "https://nghe-truyen-6dac9-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const storage = getStorage(app);
const database = getDatabase(app);

function showSection(id) {
  document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id + "-section").classList.remove("hidden");
}

window.uploadStory = async function () {
  const title = document.getElementById("story-title").value;
  const desc = document.getElementById("story-desc").value;
  const imgFile = document.getElementById("story-img").files[0];
  const audioFile = document.getElementById("story-audio").files[0];

  if (!title || !desc || !imgFile || !audioFile) {
    alert("Điền đầy đủ thông tin!");
    return;
  }

  const imgRef = sRef(storage, 'images/' + imgFile.name);
  const audioRef = sRef(storage, 'audio/' + audioFile.name);

  await uploadBytes(imgRef, imgFile);
  await uploadBytes(audioRef, audioFile);

  const imgUrl = await getDownloadURL(imgRef);
  const audioUrl = await getDownloadURL(audioRef);

  await push(ref(database, 'stories'), {
    title, desc, imgUrl, audioUrl, createdAt: Date.now()
  });

  alert("Tải truyện thành công!");
  document.getElementById("story-title").value = "";
  document.getElementById("story-desc").value = "";
  document.getElementById("story-img").value = "";
  document.getElementById("story-audio").value = "";
  showSection("home");
};

function displayStories() {
  const list = document.getElementById("story-list");
  onValue(ref(database, 'stories'), (snapshot) => {
    list.innerHTML = '';
    const data = snapshot.val();
    if (data) {
      Object.values(data).reverse().forEach(story => {
        const div = document.createElement("div");
        div.className = "story";
        div.innerHTML = `
          <h3>${story.title}</h3>
          <img src="${story.imgUrl}" alt="Ảnh truyện" />
          <p>${story.desc}</p>
          <audio controls src="${story.audioUrl}"></audio>
        `;
        list.appendChild(div);
      });
    } else {
      list.innerHTML = "<p>Chưa có truyện nào.</p>";
    }
  });
}

window.toggleMenu = function () {
  document.getElementById("menu").classList.toggle("show");
};

window.loginWithGoogle = async function () {
  try {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
    showSection("home");
  } catch (e) {
    alert("Lỗi đăng nhập Google: " + e.message);
  }
};

onAuthStateChanged(auth, (user) => {
  const authSection = document.getElementById("auth-section");
  const userInfo = document.getElementById("user-info");
  if (user) {
    authSection.innerHTML = `<button onclick="logout()">🚪 Đăng xuất</button>`;
    document.getElementById("upload-section").classList.remove("hidden");
    const name = user.displayName || "Người dùng";
    const photo = user.photoURL || "https://www.gravatar.com/avatar?d=mp";
    userInfo.innerHTML = `<img src="${photo}" alt="avatar"><span>${name}</span>`;
  } else {
    authSection.innerHTML = `<button onclick="loginWithGoogle()">🔓 Đăng nhập Google</button>`;
    document.getElementById("upload-section").classList.add("hidden");
    userInfo.innerHTML = "";
  }
});

window.logout = async function () {
  await signOut(auth);
  alert("Đã đăng xuất");
  location.reload();
};

displayStories();
</script>
</body>
</html>
