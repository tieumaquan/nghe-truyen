<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📚 Nghe Truyện Online</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    header {
      background: #0077cc;
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    main {
      padding: 1rem;
    }
    #stories {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .story-card {
      background: white;
      border: 1px solid #ccc;
      padding: 1rem;
      width: 200px;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .story-card img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 5px;
    }
    #story-player {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #admin-panel {
      background: #fff4dd;
      padding: 1rem;
      border: 1px solid #ccc;
      margin-top: 1rem;
    }
  
#dropdown-menu a {
  text-decoration: none;
  color: #0077cc;
}
#dropdown-menu li {
  margin-bottom: 8px;
}

</style>
</head>
<body>
  
<header>
  <h1>📚 Nghe Truyện Online</h1>
  <div style="display: flex; align-items: center; gap: 10px;">
    <span id="user-email" style="margin-right: 10px;"></span>
    <button id="googleSignIn">🔐 Đăng nhập Google</button>
    <button onclick="logout()" style="display:none;">Đăng xuất</button>
    <button id="menu-toggle" style="font-size: 24px; background: none; border: none; color: white;">☰</button>
  </div>
</header>


<!-- MENU ẨN -->
<nav id="dropdown-menu" style="display:none; background:#eee; padding:10px;">
  <p id="menu-username">👤</p>
  <ul style="list-style:none; padding-left:0;">
    <li id="menu-admin-link" style="display:none;"><a href="#admin-panel">📚 Quản lý truyện</a></li>
    <li><a href="#" onclick="logout()">🚪 Đăng xuất</a></li>
  </ul>
</nav>



  <main>
    <section id="story-list">
      <h2>📖 Danh sách truyện</h2>
      <div id="stories"></div>
    </section>

    <section id="story-player" style="display: none;">
      <h2 id="story-title">Tên truyện</h2>
      <img id="story-cover" src="" alt="Ảnh truyện" width="200"/>
      <audio id="story-audio" controls style="width:100%; margin-top:10px;"></audio>
      <br/><br/>
      <button onclick="hidePlayer()">⬅️ Quay lại</button>
    </section>

    <!-- ✅ ADMIN PANEL -->
    <section id="admin-panel" style="display: none;">
      <h2>🛠 Quản lý truyện (Admin)</h2>
      <form id="story-form">
        <input type="text" id="story-title" placeholder="Tên truyện" required /><br/><br/>
        <input type="file" id="story-cover-file" accept="image/*" required /><br/><br/>
        <input type="file" id="story-audio-file" accept="audio/*" required /><br/><br/>
        <button type="submit">📤 Thêm truyện</button>
      </form>
      <div id="admin-stories"></div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHg0qKWXwuZPNClwTv_VYDvfaQiLAYbJk",
      authDomain: "rinaudio-app.firebaseapp.com",
      projectId: "rinaudio-app",
      storageBucket: "rinaudio-app.appspot.com",
      messagingSenderId: "56465837529",
      appId: "1:56465837529:web:4da849806360e95cd01dc8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // Đăng nhập Google
    document.getElementById("googleSignIn").addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        alert("❌ Lỗi đăng nhập Google: " + error.message);
      }
    });

    window.logout = async () => {
      await signOut(auth);
    };

    const ADMIN_EMAIL = "sumi22122005@gmail.com";

    
// Ẩn/Hiện menu 3 gạch
document.getElementById("menu-toggle").addEventListener("click", () => {
  const menu = document.getElementById("dropdown-menu");
  menu.style.display = menu.style.display === "none" ? "block" : "none";
});


onAuthStateChanged(auth, (user) => {
  const emailSpan = document.getElementById("user-email");
  const btnGoogle = document.getElementById("googleSignIn");
  const btnLogout = document.querySelector("button[onclick='logout()']");
  const adminPanel = document.getElementById("admin-panel");
  const menuName = document.getElementById("menu-username");
  const menuAdmin = document.getElementById("menu-admin-link");

  if (user) {
    emailSpan.textContent = "👤 " + user.email;
    menuName.textContent = "👤 " + user.email;
    btnGoogle.style.display = "none";
    btnLogout.style.display = "inline-block";

    if (user.email === ADMIN_EMAIL) {
      adminPanel.style.display = "block";
      menuAdmin.style.display = "block";
      loadAdminStories();
    } else {
      adminPanel.style.display = "none";
      menuAdmin.style.display = "none";
    }
  } else {
    emailSpan.textContent = "";
    menuName.textContent = "";
    btnGoogle.style.display = "inline-block";
    btnLogout.style.display = "none";
    adminPanel.style.display = "none";
    menuAdmin.style.display = "none";
  }

  loadStories();
});


    async function loadStories() {
      const storyContainer = document.getElementById("stories");
      storyContainer.innerHTML = "";

      const snap = await getDocs(collection(db, "stories"));
      if (snap.empty) {
        storyContainer.innerHTML = "<p>Không có truyện nào.</p>";
        return;
      }

      snap.forEach((doc) => {
        const s = doc.data();
        const div = document.createElement("div");
        div.className = "story-card";
        div.innerHTML = `<strong>${s.title}</strong><br/><img src="${s.cover}" alt="cover"/>`;
        div.onclick = () => showStory(s);
        storyContainer.appendChild(div);
      });
    }

    function showStory(s) {
      document.getElementById("story-title").innerText = s.title;
      document.getElementById("story-cover").src = s.cover;
      document.getElementById("story-audio").src = s.audio;
      document.getElementById("story-player").style.display = "block";
      document.getElementById("story-list").style.display = "none";
    }

    window.hidePlayer = () => {
      document.getElementById("story-player").style.display = "none";
      document.getElementById("story-list").style.display = "block";
    };

    // THÊM TRUYỆN MỚI
    document.getElementById("story-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("story-title").value;
      const coverFile = document.getElementById("story-cover-file").files[0];
      const audioFile = document.getElementById("story-audio-file").files[0];

      try {
        const coverRef = ref(storage, "covers/" + coverFile.name);
        await uploadBytes(coverRef, coverFile);
        const coverURL = await getDownloadURL(coverRef);

        const audioRef = ref(storage, "audios/" + audioFile.name);
        await uploadBytes(audioRef, audioFile);
        const audioURL = await getDownloadURL(audioRef);

        await addDoc(collection(db, "stories"), {
          title,
          cover: coverURL,
          audio: audioURL
        });

        alert("✅ Truyện đã được thêm!");
        document.getElementById("story-form").reset();
        loadStories();
        loadAdminStories();
      } catch (err) {
        alert("❌ Lỗi thêm truyện: " + err.message);
      }
    });

    // HIỂN THỊ DANH SÁCH ADMIN
    async function loadAdminStories() {
      const adminContainer = document.getElementById("admin-stories");
      adminContainer.innerHTML = "";

      const snap = await getDocs(collection(db, "stories"));
      snap.forEach((docSnap) => {
        const s = docSnap.data();
        const id = docSnap.id;

        const div = document.createElement("div");
        div.innerHTML = `
          <p><strong>${s.title}</strong></p>
          <button onclick="deleteStory('${id}')">🗑 Xoá</button>
          <hr/>
        `;
        adminContainer.appendChild(div);
      });
    }

    window.deleteStory = async (id) => {
      if (confirm("Bạn chắc chắn muốn xoá truyện này?")) {
        await deleteDoc(doc(db, "stories", id));
        alert("✅ Đã xoá truyện");
        loadStories();
        loadAdminStories();
      }
    };
  </script>
</body>
</html>
